name: Manual Deploy to Prod

on:
  workflow_dispatch:
    inputs:
      version:
        description: "–¢–µ–≥ –æ–±—Ä–∞–∑–∞ –¥–ª—è –¥–µ–ø–ª–æ—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: v1.0.3 –∏–ª–∏ latest)"
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code (deploy branch)
        uses: actions/checkout@v4
        with:name: Manual Deploy to Prod

        on:
          workflow_dispatch:
            inputs:
              version:
                description: "–¢–µ–≥ –æ–±—Ä–∞–∑–∞ –¥–ª—è –¥–µ–ø–ª–æ—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: v1.0.3 –∏–ª–∏ latest)"
                required: true

        jobs:
          deploy:
            runs-on: ubuntu-latest

            steps:
              - name: Checkout code (deploy branch)
                uses: actions/checkout@v4
                with:
                  ref: deploy

              - name: Install yq (Mike Farah)
                run: |
                  wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
                  chmod +x /usr/local/bin/yq

              - name: Update image tag in deployment.yaml
                run: |
                  yq e ".spec.template.spec.containers[0].image = \"ghcr.io/${{ github.repository_owner }}/helloworld:${{ github.event.inputs.version }}\"" -i manifests/deployment.yaml
                  echo "üîç –ù–æ–≤—ã–π —Ç–µ–≥ –æ–±—Ä–∞–∑–∞ –ø–æ–¥—Å—Ç–∞–≤–ª–µ–Ω:"
                  yq e ".spec.template.spec.containers[0].image" manifests/deployment.yaml

              - name: Commit and push changes to deploy (via PAT)
                env:
                  TOKEN: ${{ secrets.PERSONAL_TOKEN }}
                run: |
                  git config user.name github-actions
                  git config user.email github-actions@github.com

                  git remote remove origin
                  git remote add origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}

                  git add manifests/deployment.yaml
                  git commit -m "chore: deploy ${{ github.event.inputs.version }}"
                  git push origin HEAD:deploy
          ref: deploy

      - name: Install yq (Mike Farah)
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Update image tag in deployment.yaml
        run: |
          yq e ".spec.template.spec.containers[0].image = \"ghcr.io/${{ github.repository_owner }}/helloworld:${{ github.event.inputs.version }}\"" -i manifests/deployment.yaml
          echo "üîç –ù–æ–≤—ã–π –æ–±—Ä–∞–∑:"
          grep image manifests/deployment.yaml

            - name: Commit and push changes to deploy (via PAT)
              env:
                TOKEN: ${{ secrets.PERSONAL_TOKEN }}
              run: |
                git config user.name github-actions
                git config user.email github-actions@github.com

                # —É–¥–∞–ª—è–µ–º origin –∏ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—ë–º —Å PAT
                git remote remove origin
                git remote add origin https://x-access-token:${TOKEN}@github.com/${{ github.repository }}

                echo "üì¶ Git —Å—Ç–∞—Ç—É—Å –ø–µ—Ä–µ–¥ –ø—É—à–µ–º:"
                git status
                git diff manifests/deployment.yaml

                git add manifests/deployment.yaml
                git commit -m "chore: deploy ${{ github.event.inputs.version }}"

                # –ø—É—à–∏–º —è–≤–Ω–æ —Ç–µ–∫—É—â—É—é HEAD –≤ –≤–µ—Ç–∫—É deploy
                git push origin HEAD:deploy
